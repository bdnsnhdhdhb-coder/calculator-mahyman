<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>آلة حاسبة علمية — مهيمن</title>
<script src="https://cdn.jsdelivr.net/npm/mathjs@11.8.0/dist/math.min.js"></script>
<style>
body{background:#0f172a;color:#fff;font-family:"Tajawal",sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;margin:0;padding:20px;}
h1{margin-bottom:14px;color:#38bdf8;text-shadow:0 0 10px #38bdf8;font-size:1.6rem;}
.calculator{background:#1e293b;border-radius:16px;padding:16px;box-shadow:0 0 20px rgba(14,165,233,0.12);width:360px;max-width:100%;}
#display{width:100%;height:56px;font-size:1.2rem;text-align:right;border:none;outline:none;border-radius:10px;margin-bottom:12px;padding:8px 12px;background:#0f172a;color:#38bdf8;box-sizing:border-box;}
.buttons{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;}
button{padding:14px 8px;font-size:1rem;border:none;border-radius:8px;cursor:pointer;background:#334155;color:#fff;transition:.12s;user-select:none;}
button:hover{transform:translateY(-2px);background:#0ea5e9;color:#052025;}
.op{background:#475569;}
.equals{background:linear-gradient(90deg,#06b6d4,#0891b2);color:#fff;grid-column:span 2;}
.clear{background:#ef4444;color:#fff;}
.mode{background:#f59e0b;color:#07121a;}
.small{font-size:.9rem;padding:10px 6px;}
footer{margin-top:10px;font-size:.8rem;color:#94a3b8;text-align:center;}
/* small visual feedback */
button:active{transform:translateY(0);opacity:0.95;}
</style>
</head>
<body>
<h1>آلة حاسبة علمية — مهيمن</h1>
<div class="calculator" role="application" aria-label="آلة حاسبة علمية">
  <input id="display" type="text" readonly aria-label="شاشة الآلة الحاسبة">
  <div class="buttons">
    <button class="small mode" id="degToggle">RAD</button>
    <button class="small op" onclick="insertFunc('sin')">sin</button>
    <button class="small op" onclick="insertFunc('cos')">cos</button>
    <button class="small op" onclick="insertFunc('tan')">tan</button>
    <button class="small op" onclick="insertFunc('log10')">log</button>
    <button class="small op" onclick="insertFunc('log')">ln</button>

    <button onclick="append('(')">(</button>
    <button onclick="append(')')">)</button>
    <button onclick="append('π')">π</button>
    <button onclick="append('e')">e</button>
    <button class="op" onclick="insertFunc('sqrt')">√</button>
    <button class="op" onclick="append('!')">n!</button>

    <button onclick="append('7')">7</button>
    <button onclick="append('8')">8</button>
    <button onclick="append('9')">9</button>
    <button class="op" onclick="append('÷')">÷</button>
    <button class="op" onclick="append('^')">^</button>
    <button class="op" onclick="insertFunc('abs')">abs</button>

    <button onclick="append('4')">4</button>
    <button onclick="append('5')">5</button>
    <button onclick="append('6')">6</button>
    <button class="op" onclick="append('×')">×</button>
    <button class="op" onclick="insertFunc('pow')">pow</button>
    <button class="op" onclick="append('%')">%</button>

    <button onclick="append('1')">1</button>
    <button onclick="append('2')">2</button>
    <button onclick="append('3')">3</button>
    <button class="op" onclick="append('−')">−</button>
    <button onclick="insertFunc('exp')">exp</button>
    <button class="op" onclick="insertFunc('sqrt')">root</button>

    <button onclick="append('0')">0</button>
    <button onclick="append('.')">.</button>
    <button class="equals" onclick="calculate()">=</button>
    <button onclick="append('+')">+</button>
    <button class="clear" onclick="clearDisplay()">C</button>
    <button onclick="backspace()">⌫</button>
  </div>
</div>
<footer>اضغط Enter للحساب — ESC للمسح — Backspace للحذف</footer>

<script>
/* ======== Helpers & normalization ======== */

/* map Arabic-Indic + Eastern Arabic digits to western digits */
function normalizeDigits(s){
  const map = {
    '٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9',
    '۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9'
  };
  return s.replace(/[\u0660-\u0669\u06F0-\u06F9]/g, ch => map[ch]||ch);
}

/* replace all occurrences of a pattern, safe */
function replaceAll(str, find, replace){
  return str.split(find).join(replace);
}

/* find matching parentheses to extract the full parenthesized expression ending at index */
function extractLeftOperand(expr, bangIndex){
  // if char before ! is ')' then find matching '('
  let i = bangIndex - 1;
  if(expr[i] === ')'){
    let depth = 0;
    for(; i>=0; i--){
      if(expr[i] === ')') depth++;
      else if(expr[i] === '('){
        depth--;
        if(depth === 0) break;
      }
    }
    if(i < 0) return null;
    // return substring from i to bangIndex-1
    return {start:i, text: expr.slice(i, bangIndex)};
  } else {
    // extract number or identifier to the left (digits, letters, dot, underscores)
    const m = expr.slice(0, bangIndex).match(/([A-Za-z0-9_.]+)$/);
    if(m) {
      const text = m[1];
      const start = bangIndex - text.length;
      return {start, text};
    }
    return null;
  }
}

/* replace factorial occurrences like 5! or (2+3)! -> factorial(5) or factorial((2+3)) 
   We search from right to left so nested/multiple factorials are handled predictably.
*/
function replaceFactorials(expr){
  // loop until no '!' left or limit
  let limit = 200;
  // Work on a copy
  while(expr.includes('!') && limit-->0){
    // find last '!' to correctly bind to closest left operand
    const idx = expr.lastIndexOf('!');
    const left = extractLeftOperand(expr, idx);
    if(!left) { break; }
    const leftText = left.text;
    const before = expr.slice(0, left.start);
    const after = expr.slice(idx+1);
    // wrap leftText in factorial(...)
    expr = before + 'factorial(' + leftText + ')' + after;
  }
  return expr;
}

/* preprocess full display text -> expression for mathjs */
function buildExpression(raw, isDegrees){
  if(raw === null || raw === undefined) return '';
  // normalize digits (Arabic-Indic), trim spaces
  let s = normalizeDigits(String(raw)).trim();

  // convert visible operation symbols to mathjs-friendly ones
  s = replaceAll(s, '×', '*');
  s = replaceAll(s, '÷', '/');
  // convert Arabic 'minus' char to ASCII minus
  s = replaceAll(s, '−', '-');
  s = replaceAll(s, 'π', 'pi');
  // keep 'e' as e

  // percent: convert number% => (number/100)
  // also support (...)% like (2+3)% => ((2+3)/100)
  s = s.replace(/(\([^)]+\))%/g, '($1/100)');
  s = s.replace(/([0-9.]+)%/g, '($1/100)');

  // replace factorial occurrences smartly
  s = replaceFactorials(s);

  // remove accidental repeated spaces
  s = s.replace(/\s+/g,'');

  return s;
}

/* ======== UI & Logic ======== */

const display = document.getElementById('display');
const degToggle = document.getElementById('degToggle');
let isDegrees = false;
const math = window.math;

// toggler
degToggle.addEventListener('click', () => {
  isDegrees = !isDegrees;
  degToggle.textContent = isDegrees ? 'DEG' : 'RAD';
});

function append(value){ display.value += value; }
function insertFunc(name){ display.value += name + '('; }
function clearDisplay(){ display.value = ''; }
function backspace(){ display.value = display.value.slice(0,-1); }

/* build degree-aware scope for trig functions */
function degreeScope(){
  return {
    sin: x => (isDegrees? math.sin(math.unit(x,'deg')) : math.sin(x)),
    cos: x => (isDegrees? math.cos(math.unit(x,'deg')) : math.cos(x)),
    tan: x => (isDegrees? math.tan(math.unit(x,'deg')) : math.tan(x)),
    asin: x => (isDegrees? math.asin(x) * 180 / math.pi : math.asin(x)),
    acos: x => (isDegrees? math.acos(x) * 180 / math.pi : math.acos(x)),
    atan: x => (isDegrees? math.atan(x) * 180 / math.pi : math.atan(x))
  };
}

/* validate basic structure before try-eval
   — ensures no operator at start/end (except unary minus)
   — checks balanced parentheses
   — accounts for visible Unicode operators
*/
function basicValidate(exprRaw){
  const raw = String(exprRaw || '').trim();
  if(raw.length === 0) return {ok:false, msg:'الشاشة فارغة'};
  // check parentheses balance
  let depth = 0;
  for(let ch of raw){
    if(ch === '(') depth++;
    if(ch === ')') depth--;
    if(depth < 0) return {ok:false, msg:'أقواس غير متطابقة'};
  }
  if(depth !== 0) return {ok:false, msg:'أقواس غير متطابقة'};

  // treat visible operators as equivalent to ASCII ones
  const startBad = /^[+\/*^%×÷−−–]/.test(raw); // include various minus/dash chars
  if(startBad) return {ok:false, msg:'بداية التعبير برمز غير صالح'};

  // prevent expression ending with operator (including visible ones)
  if(/[+\-*/^%×÷−]$/.test(raw)) return {ok:false, msg:'التعبير لا يمكن أن ينتهي بعامل'};

  return {ok:true};
}

function calculate(){
  const raw = display.value;
  const valid = basicValidate(raw);
  if(!valid.ok){
    alert('خطأ: ' + valid.msg + '\nتأكد من تركيب التعبير (أقواس، أرقام، عمليات).');
    return;
  }

  try{
    const expr = buildExpression(raw, isDegrees);
    // final safety check: allow digits, letters, mathjs operators, parentheses, dot, comma, and function names
    // whitelist common tokens (pi, e, factorial, pow, sqrt, sin, cos, etc.)
    if(!/^[0-9A-Za-z().,+\-*/^% _]+$/.test(expr)){
      throw new Error('رموز غير مسموحة بعد المعالجة');
    }

    const scope = Object.assign({pi: Math.PI, e: Math.E}, degreeScope());
    // expose factorial to mathjs if not present
    const config = {predictable: true};
    // math.evaluate will throw if expression is invalid; catch below
    const res = math.evaluate(expr, scope);
    // handle NaN/undefined
    if(res === undefined || res === null || (typeof res === 'number' && isNaN(res))){
      throw new Error('النتيجة غير معرّفة');
    }
    display.value = String(res);
  } catch(err){
    console.error('calc error:', err, err && err.toString && err.toString());
    alert('يوجد خطأ في العملية أو الرموز.\nرسالة الخطأ: ' + (err && err.message ? err.message : String(err)));
  }
}

/* keyboard support (maps * / to × ÷ visually to keep UI) */
document.addEventListener('keydown', (e) => {
  const allowed='0123456789+-*/.^()%';
  if(allowed.includes(e.key)){
    e.preventDefault();
    const map = {'/':'÷','*':'×'};
    append(map[e.key] || e.key);
    return;
  }
  if(e.key === 'Enter'){ e.preventDefault(); calculate(); return; }
  if(e.key === 'Backspace'){ e.preventDefault(); backspace(); return; }
  if(e.key === 'Escape'){ e.preventDefault(); clearDisplay(); return; }
});

/* paste sanitization */
display.addEventListener('paste', (ev) => {
  ev.preventDefault();
  const text = (ev.clipboardData || window.clipboardData).getData('text') || '';
  // normalize digits and allow a limited set of chars (including Unicode operators)
  const cleaned = text.replace(/[^\d\u06F0-\u06F9\u0660-\u0669A-Za-z()+\-*/^%!. ,π×÷−]/g, '');
  append(cleaned);
});
</script>
</body>
</html>
